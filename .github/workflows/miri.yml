name: Security Audit

on:
  push:
    branches: [ "main" ]
    tags-ignore:
      - '**'
  pull_request:
    branches: [ "main" ]

env:
  CARGO_TERM_COLOR: always
  CARGO_BUILD_JOBS: 2 

jobs:
  miri-parallel:
    name: MIRI Safety Checks
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust Nightly with MIRI
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: miri

      - name: Run MIRI
        run: |
          echo "Starting Parallel MIRI Suite..."

          # --- JOB 1: AVX2 ---
          (
            export RUSTFLAGS="-C target-feature=+avx2"
            export MIRIFLAGS="-Zmiri-symbolic-alignment-check"
            # Isolate build artifacts so it doesn't clash with others
            export CARGO_TARGET_DIR="target_avx2" 
            echo "[AVX2] Compiling and Testing..."
            cargo +nightly miri test avx2_miri_tests > avx2.log 2>&1
          ) & 
          PID_AVX2=$!

          # --- JOB 2: SSSE3 ---
          (
            export RUSTFLAGS="-C target-feature=+ssse3"
            export MIRIFLAGS="-Zmiri-symbolic-alignment-check"
            export CARGO_TARGET_DIR="target_ssse3"
            echo "[SSSE3] Compiling and Testing..."
            cargo +nightly miri test ssse3_miri_tests > ssse3.log 2>&1
          ) &
          PID_SSSE3=$!

          # --- JOB 3: SCALAR ---
          (
            export RUSTFLAGS=""
            export MIRIFLAGS="-Zmiri-symbolic-alignment-check"
            export CARGO_TARGET_DIR="target_scalar"
            echo "[Scalar] Compiling and Testing..."
            cargo +nightly miri test scalar_miri_tests > scalar.log 2>&1
          ) &
          PID_SCALAR=$!

          # --- WAIT FOR ALL ---
          # We wait for each specific PID and capture exit codes
          
          FAILED=0

          wait $PID_AVX2
          if [ $? -ne 0 ]; then
            echo "[AVX2] FAILED. Logs:"
            cat avx2.log
            FAILED=1
          else
            echo "[AVX2] PASSED"
          fi

          wait $PID_SSSE3
          if [ $? -ne 0 ]; then
            echo "[SSSE3] FAILED. Logs:"
            cat ssse3.log
            FAILED=1
          else
            echo "[SSSE3] PASSED"
          fi

          wait $PID_SCALAR
          if [ $? -ne 0 ]; then
            echo "[Scalar] FAILED. Logs:"
            cat scalar.log
            FAILED=1
          else
            echo "[Scalar] PASSED"
          fi

          if [ $FAILED -ne 0 ]; then
            exit 1
          fi
          
          echo "All MIRI tests passed!"

      - name: Cleanup Artifacts
        if: always()
        run: |
          rm -rf target_avx2 target_ssse3 target_scalar *.log
