name: Logic Tests

on:
  push:
    branches: [ "main" ]
    tags-ignore:
      - '**'
  pull_request:
    branches: [ "main" ]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_BUILD_JOBS: 2

jobs:
  logic-parallel:
    name: Logic Tests
    runs-on: self-hosted 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust Stable
        uses: dtolnay/rust-toolchain@stable

      - name: Run Tests
        run: |
          # 1. Disable "Exit on Error"
          set +e

          echo "Starting Parallel Logic Suite..."

          # --- 1. NO_STD (Compilation Check / Basic Tests) ---
          (
            export CARGO_TARGET_DIR="target_logic_nostd"
            echo "[no_std] Running..."
            # Note: Running test without std often requires custom harness, 
            # assuming your crate supports it or just checks compilation.
            cargo test --verbose --no-default-features --features "" > nostd.log 2>&1
          ) &
          PID_NOSTD=$!

          # --- 2. SCALAR ONLY (std) ---
          (
            export CARGO_TARGET_DIR="target_logic_scalar"
            echo "[Scalar] Running..."
            cargo test --verbose --no-default-features --features "std" > scalar.log 2>&1
          ) &
          PID_SCALAR=$!

          # --- 3. SIMD ENABLED (std, simd) ---
          (
            export CARGO_TARGET_DIR="target_logic_simd"
            echo "[SIMD] Running..."
            cargo test --verbose --no-default-features --features "std,simd" > simd.log 2>&1
          ) &
          PID_SIMD=$!

          # --- 4. PARALLEL ENABLED (std, parallel) ---
          (
            export CARGO_TARGET_DIR="target_logic_rayon"
            echo "[Rayon] Running..."
            cargo test --verbose --no-default-features --features "std,parallel" > rayon.log 2>&1
          ) &
          PID_RAYON=$!

          # --- 5. FULL FEATURES (std, simd, parallel) ---
          (
            export CARGO_TARGET_DIR="target_logic_full"
            echo "[Full] Running..."
            cargo test --verbose --no-default-features --features "std,simd,parallel" > full.log 2>&1
          ) &
          PID_FULL=$!

          # --- WAIT AND REPORT ---
          FAILED=0

          wait $PID_NOSTD
          if [ $? -ne 0 ]; then echo "[no_std] FAILED. Logs:"; cat nostd.log; FAILED=1; else echo "[no_std] PASSED"; fi

          wait $PID_SCALAR
          if [ $? -ne 0 ]; then echo "[Scalar] FAILED. Logs:"; cat scalar.log; FAILED=1; else echo "[Scalar] PASSED"; fi

          wait $PID_SIMD
          if [ $? -ne 0 ]; then echo "[SIMD] FAILED. Logs:"; cat simd.log; FAILED=1; else echo "[SIMD] PASSED"; fi

          wait $PID_RAYON
          if [ $? -ne 0 ]; then echo "[Rayon] FAILED. Logs:"; cat rayon.log; FAILED=1; else echo "[Rayon] PASSED"; fi

          wait $PID_FULL
          if [ $? -ne 0 ]; then echo "[Full] FAILED. Logs:"; cat full.log; FAILED=1; else echo "[Full] PASSED"; fi

          if [ $FAILED -ne 0 ]; then
            exit 1
          fi

          # 2. Re-enable Strict Mode
          set -e

          echo "All Logic tests passed!"

      - name: Cleanup Artifacts
        if: always()
        run: |
          rm -rf target_logic_* *.log
